ideafunnelApp.controller("SessionHomeController",["$scope","$http","$location","localStorageService",function(a,d,c,b){a.guest=null;a.initPage=function(e,f){a.userId=e;a.boardId=f;getWithErrorHandling(d,"/api/"+f+"/sessions/list","Could not load sessions",function(h,g){a.sessions=g.sessions})};a.page="welcome";a.changePage=function(e){window.location.href="#/"+e};a.chooseSession=function(e){if(e.password){a.session=e;a.page="password"}else{a.session=e;if(e.sessionType==="vote"){window.location.href="#/vote"}else{window.location.href="#/generate"}}};a.loadUser=function(){d.get("/api/user/"+a.username+"/view",{}).success(function(e){if(e.status&&e.status==="ok"){a.user=e.data}else{handleError("Could not load user",e)}a.loadingUser=false}).error(function(e){handleError("An error occurred loading your user details",e);a.loadingUser=false})};a.guestNameEntered=function(){if(!a.guestName||a.guestName.trim()===""){alert("Please enter a name")}else{a.creatingGuest=true;postWithErrorHandling(d,"/api/sessions/create-guest",{name:a.guestName},"Could not create guest",function(f,e){if(!f){a.guest=e;b.add("guestId",e._id);b.add("guestName",e.name);window.location.href="#/guest-pic"}})}};a.passwordEntered=function(){getWithErrorHandling(d,"/api/sessions/"+a.boardId+"/"+a.session._id+"/check-password?sessionPassword="+a.sessionPassword,"Invalid password",function(e){if(!e){window.location.href="#/generate"}})};a.voteForIdea=function(){if(a.currentIdea!==null){a.loadingVotes=true;var f=[];for(var e=0;e<a.votingCriteria.length;e++){if($("#criterion_"+a.votingCriteria[e]._id).val()!==""){f.push({criteriaId:a.votingCriteria[e]._id,optionId:$("#criterion_"+a.votingCriteria[e]._id).val()})}}a.currentIdeaIndex++;postWithErrorHandling(d,"/api/sessions/"+a.boardId+"/"+a.session._id+"/"+a.currentIdea._id+"/vote",{scores:f,guestId:a.guest._id},"Could not post votes",function(h,j){if(a.currentIdeaIndex<a.votingIdeas.length){a.currentIdea=a.votingIdeas[a.currentIdeaIndex];for(var g=0;g<a.votingCriteria.length;g++){$("#criterion_"+a.votingCriteria[g]._id).val("")}a.loadingVotes=false}else{a.loadingVotes=false;a.finishedVoting=true}})}};a.shuffleArray=function(h){if(!h||h.length===0){return h}for(var g=h.length-1;g>0;g--){var f=Math.floor(Math.random()*(g+1));var e=h[g];h[g]=h[f];h[f]=e}return h};a.setupVoting=function(){a.loadingVotes=true;getWithErrorHandling(d,"/api/sessions/"+a.boardId+"/"+a.session._id+"/criteria","Could not load criteria",function(e,f){a.votingCriteria=f;if(!e){getWithErrorHandling(d,"/api/sessions/"+a.boardId+"/"+a.session._id+"/ideas-unvoted?guestId="+a.guest._id,"Could not load ideas",function(h,g){if(!h){a.votingIdeas=a.shuffleArray(g);if(a.votingIdeas.length>0){a.currentIdeaIndex=0;a.currentIdea=a.votingIdeas[a.currentIdeaIndex];setTimeout(function(){window.scrollTo(0,1)},100);$("#votingScreen").removeClass("animated fadeIn");$("#votingScreen").addClass("animated fadeIn")}else{a.finishedVoting=true}a.loadingVotes=false}})}})};a.$watch(function(){return c.path()},function(){if(b.get("guestId")){a.guest={_id:b.get("guestId"),name:b.get("guestName")}}a.page=getTabPage(c.path(),"welcome");if(a.guest&&a.guest._id&&a.page!=="choose"&&a.page!=="generate"&&a.page!=="vote"){c.path("/choose")}if(a.page!=="generate"){document.ontouchmove=function(f){}}if(a.page==="guest-pic"&&!a.guest){c.path("/guest")}else{if(a.page==="generate"){if(a.session){document.ontouchmove=function(f){f.preventDefault()};var e=Hammer(document.getElementById("swipeArea"));e.on("swipeup",function(g){if(a.cardContent&&a.cardContent!==""){$("#bigCard").addClass("animated slideOutUp");a.previousCardContent=a.cardContent;var f={guest:a.guest,description:a.cardContent};if(a.sessionPassword){f.password=a.sessionPassword}postWithErrorHandling(d,"/api/sessions/"+a.boardId+"/"+a.session._id+"/create-idea",f,"Could not post idea",function(h){if(h){a.cardContent=a.previousCardContent}});setTimeout(function(){$("#bigCard").removeClass("animated slideOutUp");a.cardContent="";a.$apply()},700)}})}else{c.path("/choose")}}else{if(a.page==="vote"){if(a.session){a.setupVoting()}else{c.path("/choose")}}}}});setTimeout(function(){window.scrollTo(0,1)},1000)}]);