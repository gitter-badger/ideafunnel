ideafunnelMainApp.controller("ViewIdeaBoardController",["$scope","$http","$location","localStorageService","$routeParams","$interval","$timeout","IdeaService","$rootScope",function ViewIdeaBoardController(m,i,f,e,k,g,d,h,j){m.colours=["#E53B3A","#60A0D2","#595757","#554D97","#E7413D","#6AC15C"];m.globalSearch="";var b=600000;if(!j.ideaCache){j.ideaCache={}}m.inlineSearch={};m.maxCharacters=160;m.temporaryId=0;m.firstLoad=false;m.hotTopicsFilter=[];m.filters={hotTopics:[]};m.accessRights="open";m.selectedHotTopics=[];m.selectedSessions=[];m.sortBy=["creationDate","qualificationScore"];$("body").scrollTop(0);m.hotTopicsMap={};m.selectSession=function(q,o){o.stopPropagation();o.preventDefault();var p=false;for(var n=0;n<m.selectedSessions.length;n++){if(m.selectedSessions[n]===q._id){m.selectedSessions.splice(n,1);p=true;break}}if(!p){m.selectedSessions.push(q._id)}e.add("selectedSessions",{boardId:m.ideaBoardId,sessions:m.selectedSessions});m.loadIdeas()};m.unselectSession=function(o){for(var n=0;n<m.selectedSessions.length;n++){if(m.selectedSessions[n]===o._id){m.selectedSessions.splice(n,1);break}}};m.sessionIsSelected=function(o){if(m.selectedSessions.length===0){return false}else{for(var n=0;n<m.selectedSessions.length;n++){if(m.selectedSessions[n]===o._id){return true}}return false}};m.setSortBy=function(n){if(n==="creationDate"){m.sortBy=["creationDate","qualificationScore"]}else{m.sortBy=["qualificationScore","creationDate"]}e.add("sortBy",m.sortBy)};m.$on("hotTopicListChanged",function(n,o){m.hotTopicsFilter=o;m.filters.hotTopics=o});m.ideaBoardId=k.boardId;if(e.get("hotTopics")){var c=e.get("hotTopics");if(c.boardId===m.ideaBoardId){m.filters.hotTopics=c.selectedTopics}}if(e.get("sortBy")){m.sortBy=e.get("sortBy")}if(e.get("selectedSessions")){var a=e.get("selectedSessions");if(a.boardId===m.ideaBoardId){m.selectedSessions=a.sessions}}g.cancel(m.refreshTimer);m.getSessionColour=function(o){if(o.session&&m.board.sessions&&m.board.sessions.length>0){for(var n=0;n<m.board.sessions.length;n++){if(m.board.sessions[n]._id===o.session){return m.colours[n]}}}else{return""}};m.setIdeaListForView=function(){var o=[];if(m.ideas&&m.ideas.length>0){for(var n=0;n<m.ideas.length;n++){o.push(m.ideas[n]._id)}e.add("ideaList",o)}};m.firstLoadTimer=d(function(){if(!m.ideas||m.ideas.length===0){m.firstLoad=true}},500);m.addIdeaToHotList=function(o){if(o.importantWords){for(var n=0;n<o.importantWords.length;n++){var p=o.importantWords[n];if(!m.hotTopicsMap[p.stemmed]){m.hotTopicsMap[p.stemmed]={stemmed:p.stemmed,originals:[p.original],count:1}}else{m.hotTopicsMap[p.stemmed].count++;m.hotTopicsMap[p.stemmed].originals.push(p.original)}}m.generateRankedHotList()}};m.generateRankedHotList=function(){var n=[];for(var o in m.hotTopicsMap){n.push(m.hotTopicsMap[o])}m.hotList=n};m.compileHotList=function(){m.hotTopicsMap={};for(var p=0;p<m.ideas.length;p++){var o=m.ideas[p];if(o.importantWords&&o.importantWords.length>0){for(var n=0;n<o.importantWords.length;n++){var q=o.importantWords[n];if(!m.hotTopicsMap[q.stemmed]){m.hotTopicsMap[q.stemmed]={stemmed:q.stemmed,originals:[q.original],count:1}}else{m.hotTopicsMap[q.stemmed].count++;m.hotTopicsMap[q.stemmed].originals.push(q.original)}}}}m.generateRankedHotList()};m.processNewIdeas=function(){m.setIdeaListForView();if(e.get("lastBoardId")&&e.get("lastBoardId")===m.ideaBoardId){setTimeout(function(){$("body").scrollTop(e.get("lastIdeaScrollPos"));e.remove("lastBoardId");e.remove("lastIdeaScrollPos")},0)}m.longPollForIdeas()};m.loadIdeas=function(){m.loadingIdeas=true;var o=new Date().getTime();var q=true;if(j.ideaCache[m.ideaBoardId]&&j.ideaCache[m.ideaBoardId].timestamp>o-b){var p=j.ideaCache[m.ideaBoardId];var n=m.compareArrays(p.selectedSessions,m.selectedSessions);q=!n;if(!q){m.ideas=p.ideas;m.processNewIdeas();m.loadingIdeas=false;d.cancel(m.firstLoadTimer);m.firstLoad=false;m.compileHotList();m.longPollForIdeas()}}if(q){i.post("/api/idea-boards/"+m.ideaBoardId+"/all",{selectedSessions:m.selectedSessions}).success(function(r){if(r.status&&r.status==="ok"){m.ideas=r.data;m.setIdeaListForView();m.processNewIdeas();j.ideaCache[m.ideaBoardId]={timestamp:new Date().getTime(),ideas:r.data,selectedSessions:m.selectedSessions.slice()}}else{handleError("Could not load ideas",r)}m.loadingIdeas=false;d.cancel(m.firstLoadTimer);m.firstLoad=false;m.compileHotList()}).error(function(r){handleError("An error occurred loading ideas",r);m.loadingIdeas=false;m.firstLoad=false;d.cancel(m.firstLoadTimer)})}};m.saveBoardAccessRights=function(){var n=false;if(m.accessRights==="open"||m.accessRights==="password"){n=true;if(m.accessRights==="open"){m.board.openAccessPassword=""}}else{n=false}postWithErrorHandling(i,"/api/idea-boards/"+m.board._id+"/update/access",{openAccess:n,openAccessPassword:m.board.openAccessPassword},"Could not update board access",function(p,o){if(!p){m.board=o;$("#accessModal").modal("hide")}})};m.addNewCard=function(){$("#ideaEntryCard").html("");m.charactersLeft=m.maxCharacters;m.addingNew=true;setTimeout(function(){$("#ideaEntryCard").focus()},100)};m.cancelNewCard=function(){m.addingNew=false};m.clearFilters=function(){m.filters={}};m.createNewIdea=function(){var p=$("#ideaEntryCard").text();m.searchField="";if(p&&p.trim()!==""){m.temporaryId++;var n={description:p,_id:m.temporaryId,createdBy:m.username,pulse:true,tempId:m.temporaryId};var o=m.temporaryId;l(o);m.inlineSearch.description="";m.clearFilters();m.ideas.unshift(n);m.showCreateNew=false;i.post("/api/idea-boards/"+m.ideaBoardId+"/create",{description:p}).success(function(t,q,u,r){if(t.status&&t.status==="ok"){for(var s=0;s<m.ideas.length;s++){if(m.ideas[s].tempId&&m.ideas[s].tempId===o){m.ideas[s]._id=t.data._id;m.ideas[s].importantWords=t.data.importantWords;m.addIdeaToHotList(m.ideas[s])}}}else{handleError("Could not create idea",t)}}).error(function(q){handleError("An error occurred loading ideas",q)})}else{m.showCreateNew=false;m.$apply()}};var l=function(n){setTimeout(function(){for(var o=0;o<m.ideas.length;o++){if(m.ideas[o].tempId===n){m.ideas[o].pulse=false;break}}},1000)};$("#ideaEntryCard").on("keyup",function(o){if(o.keyCode===13){var n=m.maxCharacters-$("#ideaEntryCard").text().length;if(n>=0){o.stopPropagation();o.preventDefault();m.addingNew=false;m.createNewIdea()}else{o.stopPropagation();o.preventDefault()}}else{if(o.keyCode===27){m.addingNew=false;m.$apply();o.stopPropagation();o.preventDefault()}else{m.charactersLeft=m.maxCharacters-$("#ideaEntryCard").text().length;m.$apply();o.stopPropagation();o.preventDefault()}}});$("body").on("keydown",function(n){if(!m.addingNew&&$("#accessModal").css("display")==="none"){if(!n.metaKey){if(n.keyCode===8){if(m.globalSearch.length>0){m.globalSearch=m.globalSearch.substr(0,m.globalSearch.length-1)}m.$apply();n.preventDefault();n.stopPropagation()}else{if(n.keyCode===32){m.globalSearch=m.globalSearch+" ";m.$apply();n.preventDefault();n.stopPropagation()}else{if(n.keyCode>=48){m.globalSearch=m.globalSearch+String.fromCharCode(n.keyCode);m.$apply();n.preventDefault();n.stopPropagation()}}}}e.add("globalBoardSearch",{boardId:m.board._id,searchStr:m.globalSearch})}});m.selectIdea=function(n){e.add("lastBoardId",m.ideaBoardId);e.add("lastIdeaScrollPos",$("body").scrollTop());f.path("/boards/"+m.ideaBoardId+"/"+n._id)};m.lastIdeaTimestamp=new Date().getTime();m.longPollForIdeas=function(){i.get("/api/idea-boards/"+m.ideaBoardId+"/long-poll?lastIdeaTimestamp="+m.lastIdeaTimestamp).success(function(r){if(r.status&&r.status==="ok"){if(r.data&&r.data.length>0){m.lastIdeaTimestamp=new Date(r.data[r.data.length-1].creationDate).getTime();var q=r.data;for(var p=0;p<q.length;p++){var o=q[p];o.tempId=o._id;o.pulse=true;var s=false;for(var n=0;n<m.ideas.length;n++){if(m.ideas[n]._id===o._id){s=true}}if(!s){l(o._id);if(j.ideaCache[m.ideaBoardId]){j.ideaCache[m.ideaBoardId].ideas.unshift(o)}m.addIdeaToHotList(o)}}m.setIdeaListForView();m.compileHotList()}}m.longPollForIdeas()}).error(function(o,n){if(n&&(n!==401&&n!==0)){m.longPollForIdeas()}})};m.loadNewIdeas=function(){if(m.ideas.length&&m.ideas.length>=0){postWithErrorHandling(i,"/api/idea-boards/"+m.ideaBoardId+"/all",{since:m.ideas[0].creationDate,selectedSessions:m.selectedSessions},"Could not refresh",function(r,q){if(!r&&q&&q.length>0){for(var p=0;p<q.length;p++){var o=q[p];o.tempId=o._id;o.pulse=true;var s=false;for(var n=0;n<m.ideas.length;n++){if(m.ideas[n]._id===o._id){s=true}}if(!s){l(o._id);if(j.ideaCache[m.ideaBoardId]){j.ideaCache[m.ideaBoardId].ideas.unshift(o)}m.addIdeaToHotList(o)}}m.setIdeaListForView();m.compileHotList()}else{if(r){if(m.refreshTimer){g.cancel(m.refreshTimer)}}}})}};m.getBackgroundImageForCard=function(n){if(n&&n.hasImage){return"background-image: url('/card_images/"+n._id+".jpg'); background-size: cover; background-position: center;"}else{return""}};m.refreshTimer=null;getWithErrorHandling(i,"/api/idea-boards/view/"+k.boardId,"Could not load board",function(s,r){m.board=r;m.adminOfBoard=false;for(var p=0;p<m.board.members.length;p++){if(m.board.members[p].userId===username){if(m.board.members[p].admin){m.adminOfBoard=true}break}}if(e.get("hotTopics")){var o=e.get("hotTopics");if(o.boardId===m.board._id){m.selectedHotTopics=o.selectedTopics}}if(e.get("globalBoardSearch")){var n=e.get("globalBoardSearch");if(n.boardId===m.board._id){m.globalSearch=n.searchStr}}var q=new QRCode("largeQrCode",{text:"ideafunnel.io/"+m.board._id,width:350,height:350,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});if(m.board.openAccess){if(m.board.openAccessPassword&&m.board.openAccessPassword!==""){m.accessRights="password"}else{m.accessRights="open"}}else{m.accessRights="private"}m.loadIdeas()});m.showQrCode=function(){$("#qrModal").modal(true)};m.showAccessModal=function(){$("#accessModal").modal(true)};m.clearGlobalSearch=function(){m.globalSearch="";e.remove("globalBoardSearch")};$(".no-close-dropdown").click(function(n){n.stopPropagation()});m.selectHotTopic=function(o,p){p.preventDefault();p.stopPropagation();var q=false;for(var n=0;n<m.selectedHotTopics.length;n++){if(m.selectedHotTopics[n]===o.stemmed){m.selectedHotTopics.splice(n,1);q=true;break}}if(!q){m.selectedHotTopics.push(o.stemmed)}$("body").scrollTop(0);m.$broadcast("hotTopicListChanged",m.selectedHotTopics);e.add("hotTopics",{boardId:m.board._id,selectedTopics:m.selectedHotTopics})};m.getPercentage=function(n){if(!n||n===0){return"0%"}else{return Math.round(n*100)+"%"}};m.checkIfTopicSelected=function(o){for(var n=0;n<m.selectedHotTopics.length;n++){if(m.selectedHotTopics[n]===o.stemmed){return true}}return false};m.$on("$routeChangeStart",function(n,o){g.cancel(m.refreshTimer)});m.$on("$destroy",function(){g.cancel(m.refreshTimer);$("body").off("keydown")});m.compareArrays=function(q,p){if(!q&&!p){return true}if(!q&&p){return false}if(!p&&q){return false}if(q.length!==p.length){return false}for(var o=0,n=q.length;o<n;o++){if(q[o] instanceof Array&&p[o] instanceof Array){if(!q[o].compare(p[o])){return false}}else{if(q[o]!==p[o]){return false}}}return true}}]);